---
layout: post
title: "K8s & Helm : Pod's Liveness / Readiness Error"
date: 2021-09-12
categories: kubernetes
---

![Untitled](https://user-images.githubusercontent.com/52827441/163084789-44f147de-f511-4829-9c65-1ea6abf0681e.png)

> Helm ê³¼ K8s ë¥¼ í•¨ê»˜ ì‚¬ìš©í•˜ë©° ê²ªì—ˆë˜ Issue ë¥¼ ì •ë¦¬í•œ ê¸€ì…ë‹ˆë‹¤.
> 

## Helm ì´ë€

Helm ì€ Kubernetes ì‚¬ìš©ì„ ì¢€ ë” ìš©ì´í•˜ê²Œ ë„ì™€ì£¼ëŠ” Package Manager ì´ë‹¤.

Kubernetes Cluster ë¥¼ ì´ë£¨ê³  ìˆëŠ” ë‹¤ì–‘í•œ Object ë“¤ì€ ê°ê°ì˜ YAML íŒŒì¼ë“¤ë¡œ ì‘ì„±ë˜ê³  ê´€ë¦¬ë˜ëŠ”ë°, Cluster ì˜ ê·œëª¨ê°€ ì»¤ì§ˆ ìˆ˜ë¡ ê´€ë¦¬í•´ì•¼í•˜ëŠ” íŒŒì¼ë“¤ì˜ ìˆ˜ê°€ ëŠ˜ì–´ë‚  ìˆ˜ ë°–ì— ì—†ë‹¤.

ì´ ë•Œ, Helm ì€ Template ì´ë¼ëŠ” ê¸°ëŠ¥ì„ í†µí•´ ë³€ë™ì„±ì´ ë†’ì€ ê°’ë“¤ì„ ë³€ìˆ˜ë¡œ ì‘ì„±í•  ìˆ˜ ìˆê²Œ í•´ì£¼ê³  `values.yaml` íŒŒì¼ì—ì„œ í•´ë‹¹ ê°’ë“¤ë§Œ ë”°ë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆê²Œ ë„ì™€ì¤€ë‹¤. Helm ì€ Template ìƒì˜ ë³€ìˆ˜ë“¤ì— ê°ê° ëŒ€ì‘í•˜ëŠ” ê°’ë“¤ì„ í• ë‹¹í•´ ê°ê°ì˜ K8s Object ì„¤ì • í…œí”Œë¦¿ë“¤ì„ ë™ì ìœ¼ë¡œ YAML íŒŒì¼ë¡œ ë³€í™˜í•´ì¤€ë‹¤. ([ë¬¸ì„œ](https://helm.sh/ko/docs/chart_best_practices/templates/) ì°¸ì¡°)

ê·¸ë¦¬ê³  ìƒì„±ëœ YAML íŒŒì¼ë“¤ì˜ ë²ˆë“¤ì„ Chart ë¼ê³  ë¶€ë¥´ë©°, í•´ë‹¹ Chart ë“¤ì„ Cloud Repository ì— push í•˜ê³  download í•  ìˆ˜ ìˆë‹¤.

## Issue ì„¤ëª…

NodeJS App ì˜ Docker image ë¥¼ K8s cluster ì— ë„ìš°ëŠ” ê²ƒì—” íŠ¹ë³„í•œ ë¬¸ì œê°€ ì—†ì—ˆë‹¤.

ê·¸ëŸ°ë°,
`helm install mynode ./`
ë¡œ Helm Chart ë¥¼ ìƒì„±í•˜ê³  K8s Deployment ë¥¼ ìƒì„±í–ˆë”ë‹ˆ ì•„ë˜ì™€ ê°™ì€ í˜„ìƒì´ ë‚˜íƒ€ë‚¬ë‹¤.

![Untitled 1](https://user-images.githubusercontent.com/52827441/163084748-972290db-f3d0-4248-977a-2e8460277af0.png)

Pod ë“¤ì´ Running ì¤‘ì´ì§€ë§Œ, READY ìƒíƒœê°€ ì•„ë‹ˆë¼ê³  í‘œì‹œë˜ê³  ìˆë‹¤.

![Untitled 2](https://user-images.githubusercontent.com/52827441/163084758-9fd4793e-412c-4bbc-8bec-7a544aa26ae4.png)

Pod ì„ describe í•´ë³´ë‹ˆ `Liveness` ì™€ `Readiness` ë¥¼ ì²´í¬í•˜ëŠ” connection ì´ refuse ëœë‹¤ê³  í•œë‹¤.

ì´ë•Œë¶€í„° ëì„ ì•Œ ìˆ˜ ì—†ëŠ” ì‚½ì§ˆì„ ì‹œì‘í•˜ê²Œ ë˜ì—ˆë‹¤.

Helm ì—†ì´ K8s cluster ì— ë„ì›Œë³´ê³  Docker image ë„ ìƒˆë¡œ ë¹Œë“œí•´ë³´ê³ ..
Helm ë§Œ ì—†ìœ¼ë©´ ë„ˆë¬´ ì˜ ë™ì‘í•œë‹¤...

`minikube service { service name } --url`
ëª…ë ¹ì–´ë¡œ í•´ë‹¹ NodePort Service ì— ì ‘ì†í•  ìˆ˜ ìˆëŠ” tunnel ê³¼ url ì„ ìƒì„±í•´ ì ‘ì†í•´ë„ 404 ì—ëŸ¬ê°€ ë°˜í™˜ë˜ì—ˆë‹¤.

> Pod ì´ READY ìƒíƒœê°€ ì•„ë‹ˆë¼ëŠ” ê²ƒì€ Pod ë‚´ë¶€ì— í•˜ë‚˜ ì´ìƒì˜ container ê°€ ì•„ì§ traffic ì„ accept í•  ìˆ˜ ì—†ëŠ” ìƒíƒœë¼ëŠ” ëœ»ì´ë‹¤ ~~(ê¸€ ê°€ì¥ ì•„ë˜ì— ì„¤ëª…)~~.  ì¦‰,  Service ë¥¼ ì„¤ì •í•´ë‘ì–´ë„ ì—°ê²°ì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤.
> 

## Issue í•´ê²°í•˜ê¸°

ë¹„êµ Test ë¥¼ ìœ„í•´ `values.yaml` íŒŒì¼ì˜ Docker image ë¥¼ `mynode` image ê°€ ì•„ë‹Œ  [nginx:latest](https://hub.docker.com/_/nginx) ë¡œ ë³€ê²½í•´ë³´ì•˜ë‹¤.

![Untitled 3](https://user-images.githubusercontent.com/52827441/163084765-b5743fa4-ade9-4556-988d-a8ffb9b3e7ac.png)

![Untitled 4](https://user-images.githubusercontent.com/52827441/163084768-2cfc03c5-fb93-4712-8623-d99873da7920.png)

ë¬¸ì œ ì—†ì´ Pod ë“¤ì´ Ready ìƒíƒœë¡œ ì˜ í‘œì‹œëœë‹¤.
ë§ˆì°¬ê°€ì§€ë¡œ, `mynode` image ë˜í•œ Helm ì—†ì´ Local ì—ì„œ K8s cluster ì— ë„ìš°ë©´ ì´ì™€ ê°™ì´ Pod ë“¤ì´ ì •ìƒì ìœ¼ë¡œ READY í‘œì‹œê°€ ëœë‹¤.

ì¦‰, `nginx` ì™€ `mynode` ì´ë¯¸ì§€ê°€ `liveness` ì™€ `readiness` ì²´í¬ì— ì‘ë‹µí•˜ëŠ” ë°©ì‹ì— ì°¨ì´ê°€ ìˆëŠ” ê²ƒ ê°™ë‹¤.

---

ê·¸ í›„, 'K8s ì—ì„œ App ì˜ Health Check' ì™€ ê´€ë ¨ëœ [ìƒˆë¡œìš´ ë¬¸ì„œ](https://developer.ibm.com/tutorials/health-checking-kubernetes-nodejs-application) ë¥¼ ì°¾ê²Œ ë˜ì—ˆê³  ì´ë¥¼ í†µí•´  app ë‚´ì— ì§ì ‘ `liveness` ì™€ `readiness` ì²´í¬ì— ëŒ€í•œ ì˜¬ë°”ë¥¸ ì‘ë‹µì„ ì£¼ë„ë¡ ë§Œë“¤ ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì„ ì•Œê²Œ ë˜ì—ˆë‹¤.

í•´ë‹¹ ë¬¸ì„œë¥¼ ë”°ë¼ [health-connect](https://www.npmjs.com/package/@cloudnative/health-connect) ì´ë¼ëŠ”  package (nodejs ìš© open source package) ë¥¼ ì‚¬ìš©í–ˆê³ ,
README ë¥¼ ë”°ë¼ ì´ëŸ° ì‹ìœ¼ë¡œ liveness ì™€ readiness check ë¥¼ ê°ê° ì›í•˜ëŠ” url ì—ì„œ ì‘ë‹µí•˜ëŠ” ì½”ë“œë¥¼ ì¶”ê°€í•´ì¤¬ë‹¤.

![Untitled 5](https://user-images.githubusercontent.com/52827441/163084775-a5361d3d-6ff0-4e96-a99d-8c71f2fac231.png)

ë§ˆì°¬ê°€ì§€ë¡œ, Helm ì˜ template ì¸ `deployment.yaml` ì—ë„ `livenessProbe` ì™€ `readinessProbe` ì˜ ì •ë³´ë¥¼ ëª…í™•íˆ ë„£ì–´ì¤€ë‹¤. (port ëŠ” containerPort ì™€ ë™ì¼í•˜ê²Œ)

![Untitled 6](https://user-images.githubusercontent.com/52827441/163084778-234b9e77-a0df-4242-b1d8-0651319a1ad2.png)

> [K8s ë¬¸ì„œ](https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#define-a-liveness-command) ì— ë”°ë¥´ë©´, initialDelaySeconds ëŠ” ì²«ë²ˆì§¸ probe (í™•ì¸)ì„ ì‹œë„í•˜ê¸°ê¹Œì§€ delay (ì´ˆ ë‹¨ìœ„) ë¥¼ ì„¤ì •í•´ì£¼ëŠ” field ë¼ê³  í•œë‹¤.
[stackoverflow ê¸€](https://stackoverflow.com/questions/48540929/kubernetes-readiness-probe-failed-error/68481541#68481541)ì„ ì°¸ê³ í•´ì„œ 5ì´ˆë¡œ ì„¤ì •í•´ì£¼ì—ˆë‹¤. (values.yaml ì— ì„¤ì •)
> 
> 
> ![Untitled 7](https://user-images.githubusercontent.com/52827441/163084781-92ecfbf5-d690-4203-8c83-feb3c461d604.png)
> 

---

ì´ì œ ë‹¤ì‹œ `helm install` ì„ ì‹¤í–‰í•´ Chart ë¥¼ ìƒì„±í•˜ê³  K8s cluster ì— deployment ë¥¼ ë„ì›Œë³¸ë‹¤.

![Untitled 8](https://user-images.githubusercontent.com/52827441/163084782-cf8ce9ed-33f7-47b0-9746-223aa0142fbf.png)

### ì„±ê³µ!!! ğŸ¤©

---

`minikube service { service name } --url`
ëª…ë ¹ì–´ë¡œ í•´ë‹¹ NodePort Service ì— ì ‘ì†í•  ìˆ˜ ìˆëŠ” tunnel ê³¼ url ì„ ìƒì„±í•´ë³´ì.

![Untitled 9](https://user-images.githubusercontent.com/52827441/163084785-1ab8838b-103b-466a-8470-e9a11168a7b3.png)

ì˜ ë™ì‘í•œë‹¤. :)

## ìƒˆë¡­ê²Œ ì•Œê²Œëœ ê²ƒë“¤

> **Helm ì—ì„œë§Œ í•´ë‹¹ ì´ìŠˆê°€ ë°œìƒí•˜ë˜ ì´ìœ  :**
ë‚˜ì¤‘ì— ë¹„êµë¥¼ í•´ë³´ë‹ˆ,
Helm ì—ì„œ ê¸°ë³¸ìœ¼ë¡œ ì œê³µí•˜ëŠ” deployment.yaml Template ê³¼ ë‚´ê°€ ì§ì ‘ ë§Œë“¤ì–´ ì‚¬ìš©í•˜ë˜ deployment.yaml íŒŒì¼ì— ì°¨ì´ê°€ ìˆì—ˆë‹¤.ë°”ë¡œ livenessProbe ê³¼  readinessProbe ì„¤ì •ì˜ ìœ ë¬´ì¸ë°,
ì´ probe ë¥¼ ì›í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ í•´ë‹¹ ì„¤ì •ì„ ì œê±°í•˜ë©´ ë˜ê³ , ê·¸ëŸ¼ probe ê¸°ëŠ¥ ì—†ì´ (ìœ„ì˜ ì´ìŠˆë„ ì—†ì´) Pod ì„ ë„ì›Œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

> ì´ ë¶€ë¶„,
> 
> 
> ![Untitled 10](https://user-images.githubusercontent.com/52827441/163084786-f7bf2bbc-9b39-43f3-8150-37af9a74241a.png)
> 

---

 **[ë¬¸ì„œ](https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#define-a-liveness-command)ì—ì„œ livenessProbe ì™€ readinessProbe ì— ëŒ€í•´ ì½ì–´ë³´ì•˜ë‹¤.**
- **livenessProbe :**
K8s Node ì˜ Agent ì¸ kubelet ì€ container ë“¤ì´ ì„¤ì •ëœ ëŒ€ë¡œ ì˜ ë™ì‘í•˜ë„ë¡ ê´€ë¦¬í•˜ëŠ”ë°, livenessProbe ì„ í†µí•´ container ë¥¼ ì–¸ì œ restart í•  ê²ƒì¸ì§€ ê²°ì •í•œë‹¤ê³  í•œë‹¤.ì˜ˆë¥¼ ë“¤ì–´, app ì´ ì—¬ì „íˆ ì‹¤í–‰ì¤‘ì´ì§€ë§Œ ë” ì´ìƒ ì§„í–‰ë  ìˆ˜ ì—†ëŠ” deadlock ì´ ë°œìƒí•œ ê²½ìš°ì—ë„ livenessProbe ë¥¼ í†µí•´ íƒì§€í•˜ê³  container ë¥¼ restart í•  ìˆ˜ ìˆë‹¤ê³  í•œë‹¤.
ì´ë¥¼ í†µí•´, container ì— bug ê°€ ë°œìƒí•´ë„ restart í†µí•´ ë‹¤ì‹œ ì‚¬ìš© ê°€ëŠ¥ ìƒíƒœë¡œ ëŒë¦´ ìˆ˜ ìˆë‹¤.

- **readinessProbe :**
kubelet ì€ readinessProbe ì„ í†µí•´ container ì˜ ready ìƒíƒœë¥¼ í™•ì¸í•œë‹¤ê³  í•œë‹¤.
container ì˜ ready ìƒíƒœë€ when a container is ready to start accepting traffic ì´ê³ 
Pod ì˜ ready ìƒíƒœë€ ëª¨ë“  container ë“¤ì´ ready ìƒíƒœì¼ ë•Œë¥¼ ì˜ë¯¸í•œë‹¤.

